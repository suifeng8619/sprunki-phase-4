{% extends "base/head_foot.html" %}

{% block title %}{{ info.article.title }} - Sprunki Phase 4{% endblock %}
{% block description %}{{ info.article.jianjie }}{% endblock %}

{% block head %}
    {# 结构化数据 #}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "VideoGame",
      "name": "{{ info.article.title | e }}",
      "description": "{{ info.article.jianjie | e }}",
      "url": "https://sprunkiphase4.net/{{ info.article.ids }}.html",
      "image": "{{ info.article.image_url }}",
      "gamePlatform": ["PC", "Web Browser", "Mobile Browser"],
      "applicationCategory": "Game",
      "genre": ["music game", "sprunki mod", "sprunki incredibox game"],
      "publisher": {
        "@type": "Organization",
        "name": "Sprunki Incredibox Game",
        "url": "https://sprunkiphase4.net"
      }
    }
    </script>
{% endblock %}

{% block content %}
    {# 面包屑导航 #}
    <nav class="breadcrumb-nav" aria-label="Breadcrumb">
        <div class="container">
            <ol class="breadcrumb-list" itemscope itemtype="https://schema.org/BreadcrumbList">
                <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="{{ url_for('base_url.index_lang', lang=no_en_lang()) }}" class="breadcrumb-link breadcrumb-home" itemprop="item">
                        <svg class="breadcrumb-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd"/>
                        </svg>
                        <span itemprop="name">{{ _("Home") }}</span>
                    </a>
                    <meta itemprop="position" content="1"/>
                </li>
                <li class="breadcrumb-separator">/</li>
                <li class="breadcrumb-item breadcrumb-current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <span itemprop="name">{{ info.article.title }}</span>
                    <meta itemprop="position" content="2"/>
                </li>
            </ol>
        </div>
    </nav>

    <main class="main-content">
        {# 游戏区域 #}
        <section id="game_section" class="game-section" aria-labelledby="game-title">
            <div class="game-container">
                <div id="game_intro" class="game-intro">
                    <div class="game-icon">
                        <img src="{{ info.article.image_url }}"
                             alt="{{ info.article.title }} game icon"
                             loading="eager">
                    </div>
                    <h1 id="game-title" class="game-title">{{ info.article.title }}</h1>
                    <p class="game-description">{{ info.article.jianjie }}</p>

                    {# 音频提示 #}
                    <div class="audio-notice">
                        <div class="audio-notice-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                            </svg>
                        </div>
                        <div class="audio-notice-content">
                            <div class="audio-notice-title">{{ _("Audio Guide") }}</div>
                            <div class="audio-notice-text">{{ _("If you're not hearing game audio, please check if your device is muted. If it's unmuted but still no sound, tap the browser's share button and find 'Add to Home Screen', then open the app from your home screen for perfect fullscreen and proper audio.") }}</div>
                        </div>
                    </div>

                    <button class="play-button" onclick="playGameWithAudio()" aria-label="Play {{ info.article.title }} game">
                        <svg class="play-button-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                        </svg>
                        {{ _("PLAY GAME") }}
                    </button>
                </div>

                <iframe id="game_iframe"
                        class="game-iframe hidden"
                        title="{{ info.article.title }}"
                        loading="lazy"
                        src="{{ info.article.iframe|safe }}"
                        allow="autoplay; fullscreen; microphone; camera; midi; encrypted-media; gyroscope; accelerometer"
                        allowfullscreen
                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-pointer-lock allow-orientation-lock allow-modals">
                </iframe>
            </div>
        </section>

        {# 游戏状态栏 #}
        <div id="game-status-bar" class="game-status-bar">
            <div class="game-status-info">
                <div class="game-status-icon">
                    <img src="{{ info.article.image_url }}" alt="{{ info.article.title }}">
                </div>
                <h2 class="game-status-title">{{ info.article.title }}</h2>
            </div>
            <div class="game-status-controls">
                <button id="comments-btn" onclick="scrollToComments()" class="status-btn status-btn-purple" title="{{ _('View Comments') }}">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                    </svg>
                    <span class="status-btn-text">{{ _("Comments") }}</span>
                </button>
                <button id="status-native-fullscreen-btn" type="button" class="status-btn status-btn-green" title="{{ _('Native Fullscreen') }}">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <g fill="none" stroke="currentColor" stroke-width="12" stroke-linecap="square">
                            <path d="M20 35 L20 20 L35 20"/><path d="M80 35 L80 20 L65 20"/>
                            <path d="M20 65 L20 80 L35 80"/><path d="M80 65 L80 80 L65 80"/>
                        </g>
                    </svg>
                    <span class="status-btn-text">{{ _("Fullscreen") }}</span>
                </button>
                <button id="status-pseudo-fullscreen-btn" type="button" class="status-btn status-btn-blue" title="{{ _('Pseudo Fullscreen') }}">
                    <svg viewBox="0 0 70 70" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5" y="5" width="60" height="60" fill="none" stroke="currentColor" stroke-width="6" rx="3"/>
                        <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="square">
                            <path d="M15 25 L15 15 L25 15"/><path d="M55 25 L55 15 L45 15"/>
                            <path d="M15 45 L15 55 L25 55"/><path d="M55 45 L55 55 L45 55"/>
                        </g>
                    </svg>
                    <span class="status-btn-text">{{ _("Expand") }}</span>
                </button>
                <button id="game-refresh-btn" type="button" onclick="refreshGame()" class="status-btn status-btn-orange" title="{{ _('Refresh Game') }}">
                    <svg viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                    <span class="status-btn-text">{{ _("Refresh") }}</span>
                </button>
            </div>
        </div>

        {# 游戏推荐 #}
        <section class="section">
            <div class="container">
                <h2 class="section-title">{{ _("Game Recommendations") }}</h2>
                <div class="games-grid">
                    {% for game in datas %}
                        {% set game = {'url': game.url, 'image': game.image, 'title': game.title} %}
                        {% include "components/game-card.html" %}
                    {% endfor %}
                </div>
            </div>
        </section>

        {# 评论系统 #}
        <section id="comments-section" class="section comments-section">
            <div class="container">
                <div class="comments-header">
                    <h2 class="section-title">{{ _("Player Reviews") }}</h2>
                    <div class="comments-stats">
                        <span id="total-comments">0 {{ _("comments") }}</span>
                        <span class="comments-stats-divider">•</span>
                        <span id="average-rating">0.0 ★</span>
                    </div>
                </div>

                {# 评论表单 #}
                <div class="comment-form">
                    <div class="comment-form-avatar">U</div>
                    <div class="comment-form-content">
                        <div class="comment-rating">
                            <label class="comment-rating-label">{{ _("Your Rating") }}</label>
                            <div class="rating-stars">
                                <span class="rating-star" data-rating="1">★</span>
                                <span class="rating-star" data-rating="2">★</span>
                                <span class="rating-star" data-rating="3">★</span>
                                <span class="rating-star" data-rating="4">★</span>
                                <span class="rating-star" data-rating="5">★</span>
                            </div>
                        </div>
                        <div class="comment-textarea-wrapper">
                            <textarea id="comment-input" class="comment-textarea" placeholder="{{ _('Share your thoughts about this game...') }}" rows="3"></textarea>
                            <button type="button" id="emoji-btn" class="emoji-btn" title="Insert emoji">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                </svg>
                            </button>
                            <div id="emoji-panel" class="emoji-panel hidden"></div>
                        </div>
                        <div class="comment-inputs">
                            <input type="text" id="username-input" class="comment-input" placeholder="{{ _('Your name (optional)') }}">
                            <input type="email" id="email-input" class="comment-input" placeholder="{{ _('Your email (optional)') }}">
                        </div>
                        <button onclick="submitComment()" class="btn btn-primary">
                            <span id="submit-text">{{ _("Post Comment") }}</span>
                            <div id="submit-loading" class="loading-spinner hidden"></div>
                        </button>
                    </div>
                </div>

                <div id="comments-list">
                    <div id="loading-comments" class="comments-skeleton">
                        {# 骨架屏 - 模拟3条评论 #}
                        {% for i in range(3) %}
                        <div class="skeleton-comment">
                            <div class="skeleton-avatar"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-header">
                                    <div class="skeleton-name"></div>
                                    <div class="skeleton-date"></div>
                                </div>
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div id="load-more-section" class="text-center hidden">
                    <button onclick="loadMoreComments()" class="btn btn-secondary" id="load-more-btn">
                        {{ _("Load More Comments") }}
                    </button>
                </div>
            </div>
        </section>

        {# 游戏介绍内容 #}
        <section class="section about-section">
            <div class="container">
                <h2 class="section-title">{{ info.article.title }}</h2>
                <div class="about-content glass-card prose-content">
                    {{ info.article.content|safe }}
                </div>
            </div>
        </section>
    </main>

    {# 浮动返回游戏按钮 #}
    <button id="backToGameBtn" class="back-to-game-btn" onclick="scrollToGame()">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/>
        </svg>
        <span>{{ _("Back to Game") }}</span>
    </button>

    {# 回复表单模板 #}
    <template id="reply-form-template">
        <div class="reply-form">
            <h4 class="reply-form-title">Reply to @<span class="reply-to-username"></span></h4>
            <input type="text" class="reply-username comment-input" placeholder="Your name (optional)">
            <textarea class="reply-content comment-textarea" placeholder="Enter your reply..." rows="3" required></textarea>
            <div class="reply-form-actions">
                <button type="button" class="submit-reply-btn btn btn-primary btn-sm">Submit</button>
                <button type="button" class="cancel-reply-btn btn btn-secondary btn-sm">Cancel</button>
            </div>
        </div>
    </template>

    {# 游戏脚本 #}
    <script>
        // 游戏启动函数
        window.playGame = window.playGame || function() {
            const gameIntro = document.getElementById('game_intro');
            const gameIframe = document.getElementById('game_iframe');
            if (gameIntro && gameIframe) {
                gameIntro.classList.add('hidden');
                gameIframe.classList.remove('hidden');
                window.dispatchEvent(new Event('gameStarted'));
            }
        };

        window.playGameWithAudio = function() {
            window.playGame();
            // 尝试激活音频上下文
            setTimeout(() => {
                try {
                    if (window.AudioContext || window.webkitAudioContext) {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        if (ctx.state === 'suspended') ctx.resume();
                    }
                } catch (e) {}
            }, 100);
        };

        function refreshGame() {
            const gameIframe = document.getElementById('game_iframe');
            if (gameIframe) {
                const src = gameIframe.src;
                gameIframe.src = '';
                setTimeout(() => gameIframe.src = src, 100);
            }
        }

        function scrollToGame() {
            document.getElementById('game_section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function scrollToComments() {
            document.getElementById('comments-section')?.scrollIntoView({ behavior: 'smooth' });
        }

        // 浮动按钮显示控制
        function toggleBackToGameButton() {
            const btn = document.getElementById('backToGameBtn');
            const gameSection = document.getElementById('game_section');
            if (!btn || !gameSection) return;

            const gameRect = gameSection.getBoundingClientRect();
            btn.classList.toggle('show', gameRect.bottom < 0);
        }

        let scrollTimeout;
        window.addEventListener('scroll', function() {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(toggleBackToGameButton, 10);
        });
    </script>

    {# 延迟加载评论系统 #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                var commentsCss = document.createElement('link');
                commentsCss.rel = 'stylesheet';
                commentsCss.href = '{{ url_for("static", filename="css/comments.css") }}';
                document.head.appendChild(commentsCss);

                var commentsJs = document.createElement('script');
                commentsJs.src = '{{ url_for("static", filename="js/min/comments.min.js") }}';
                commentsJs.onload = function() {
                    if (typeof initializeCommentSystem === 'function') {
                        initializeCommentSystem();
                    }
                };
                document.body.appendChild(commentsJs);

                var emojiJs = document.createElement('script');
                emojiJs.src = '{{ url_for("static", filename="js/min/emoji-picker.min.js") }}';
                document.body.appendChild(emojiJs);
            }, 1000);
        });
    </script>

    {# 延迟加载全屏脚本 #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                var fullscreenJs = document.createElement('script');
                fullscreenJs.src = "{{ url_for('static', filename='style/min/fullscreen.min.js') }}";
                fullscreenJs.onload = function() {
                    var nativeFullscreenJs = document.createElement('script');
                    nativeFullscreenJs.src = "{{ url_for('static', filename='style/min/native-fullscreen.min.js') }}";
                    nativeFullscreenJs.onload = function() {
                        setTimeout(function() {
                            var gameStatusBarJs = document.createElement('script');
                            gameStatusBarJs.src = "{{ url_for('static', filename='js/min/game-status-bar.min.js') }}";
                            document.body.appendChild(gameStatusBarJs);
                        }, 200);
                    };
                    document.body.appendChild(nativeFullscreenJs);
                };
                document.body.appendChild(fullscreenJs);

                var scriptJs = document.createElement('script');
                scriptJs.src = "{{ url_for('static', filename='style/min/script.min.js') }}";
                document.body.appendChild(scriptJs);
            }, 500);
        });
    </script>
{% endblock %}
