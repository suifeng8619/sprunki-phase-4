<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA æµ‹è¯•é¡µé¢</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 8px 8px 8px 0;
        }
        button:hover { background: #7c3aed; }
    </style>
</head>
<body>
    <h1>ğŸ”§ PWA é…ç½®æµ‹è¯•</h1>
    
    <div class="test-card">
        <h2>ğŸ“± è®¾å¤‡æ£€æµ‹</h2>
        <div id="device-info"></div>
    </div>
    
    <div class="test-card">
        <h2>ğŸ”— ç½‘ç»œçŠ¶æ€</h2>
        <div id="network-info"></div>
    </div>
    
    <div class="test-card">
        <h2>âš™ï¸ PWA æ”¯æŒæ£€æµ‹</h2>
        <div id="pwa-support"></div>
    </div>
    
    <div class="test-card">
        <h2>ğŸ“„ èµ„æºæµ‹è¯•</h2>
        <div id="resource-test"></div>
        <button onclick="testResources()">æµ‹è¯•èµ„æºåŠ è½½</button>
    </div>
    
    <div class="test-card">
        <h2>ğŸ”§ Service Worker çŠ¶æ€</h2>
        <div id="sw-status"></div>
        <button onclick="registerSW()">æ³¨å†Œ Service Worker</button>
        <button onclick="unregisterSW()">å¸è½½ Service Worker</button>
    </div>
    
    <div class="test-card">
        <h2>ğŸ“± å®‰è£…æµ‹è¯•</h2>
        <div id="install-status"></div>
        <button onclick="triggerInstall()">è§¦å‘å®‰è£…</button>
    </div>

    <script>
        // è®¾å¤‡æ£€æµ‹
        function detectDevice() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone || 
                                document.referrer.includes('android-app://');
            
            document.getElementById('device-info').innerHTML = `
                <div class="status info">User Agent: ${navigator.userAgent}</div>
                <div class="status ${isIOS ? 'success' : 'info'}">iOS è®¾å¤‡: ${isIOS ? 'æ˜¯' : 'å¦'}</div>
                <div class="status ${isSafari ? 'success' : 'info'}">Safari æµè§ˆå™¨: ${isSafari ? 'æ˜¯' : 'å¦'}</div>
                <div class="status ${isStandalone ? 'success' : 'warning'}">ç‹¬ç«‹æ¨¡å¼: ${isStandalone ? 'æ˜¯' : 'å¦'}</div>
            `;
        }

        // ç½‘ç»œçŠ¶æ€
        function checkNetwork() {
            const protocol = location.protocol;
            const isHTTPS = protocol === 'https:';
            
            document.getElementById('network-info').innerHTML = `
                <div class="status info">å½“å‰åè®®: ${protocol}</div>
                <div class="status ${isHTTPS ? 'success' : 'error'}">HTTPS: ${isHTTPS ? 'æ˜¯' : 'å¦'}</div>
                <div class="status info">åœ¨çº¿çŠ¶æ€: ${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
            `;
        }

        // PWA æ”¯æŒæ£€æµ‹
        function checkPWASupport() {
            const hasSW = 'serviceWorker' in navigator;
            const hasManifest = document.querySelector('link[rel="manifest"]');
            const hasBeforeInstallPrompt = 'onbeforeinstallprompt' in window;
            
            document.getElementById('pwa-support').innerHTML = `
                <div class="status ${hasSW ? 'success' : 'error'}">Service Worker: ${hasSW ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}</div>
                <div class="status ${hasManifest ? 'success' : 'error'}">Manifest: ${hasManifest ? 'å·²é…ç½®' : 'æœªé…ç½®'}</div>
                <div class="status ${hasBeforeInstallPrompt ? 'success' : 'info'}">å®‰è£…æç¤º: ${hasBeforeInstallPrompt ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ (iOSæ­£å¸¸)'}</div>
            `;
        }

        // èµ„æºæµ‹è¯•
        async function testResources() {
            const resources = [
                '{{ url_for("static", filename="manifest.json") }}',
                '{{ url_for("static", filename="pwa-sw.js") }}',
                '{{ url_for("static", filename="icon-192.png") }}',
                '{{ url_for("static", filename="icon-512.png") }}'
            ];
            
            let results = '';
            for (const resource of resources) {
                try {
                    const response = await fetch(resource);
                    const status = response.ok ? 'success' : 'error';
                    results += `<div class="status ${status}">${resource}: ${response.status}</div>`;
                } catch (error) {
                    results += `<div class="status error">${resource}: åŠ è½½å¤±è´¥</div>`;
                }
            }
            
            document.getElementById('resource-test').innerHTML = results;
        }

        // Service Worker æ“ä½œ
        async function registerSW() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('{{ url_for("static", filename="pwa-sw.js") }}');
                    document.getElementById('sw-status').innerHTML = `
                        <div class="status success">æ³¨å†ŒæˆåŠŸ: ${registration.scope}</div>
                    `;
                } catch (error) {
                    const registration = await navigator.serviceWorker.register('{{ url_for("static", filename="pwa-sw.js") }}');
                    document.getElementById('sw-status').innerHTML = `
                        <div class="status error">æ³¨å†Œå¤±è´¥: ${error.message}</div>
                    `;
                }
            } else {
                document.getElementById('sw-status').innerHTML = `
                    <div class="status error">ä¸æ”¯æŒ Service Worker</div>
                `;
            }
        }

        async function unregisterSW() {
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                }
                document.getElementById('sw-status').innerHTML = `
                    <div class="status info">å·²å¸è½½æ‰€æœ‰ Service Worker</div>
                `;
            }
        }

        // å®‰è£…æµ‹è¯•
        let deferredPrompt;
        // å¤šè¡Œæ³¨é‡Š

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-status').innerHTML = `
                <div class="status success">å¯ä»¥å®‰è£…! beforeinstallprompt äº‹ä»¶å·²è§¦å‘</div>
            `;
        });
        /*
  async function triggerInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                document.getElementById('install-status').innerHTML = `
                    <div class="status ${outcome === 'accepted' ? 'success' : 'warning'}">
                        ç”¨æˆ·é€‰æ‹©: ${outcome === 'accepted' ? 'åŒæ„å®‰è£…' : 'æ‹’ç»å®‰è£…'}
                    </div>
                `;
                deferredPrompt = null;
            } else {
                document.getElementById('install-status').innerHTML = `
                    <div class="status warning">æ— æ³•å®‰è£… - å¯èƒ½å·²å®‰è£…æˆ–æµè§ˆå™¨ä¸æ”¯æŒ</div>
                `;
            }
        }
        */


        // åˆå§‹åŒ–
        detectDevice();
        checkNetwork();
        checkPWASupport();
        
        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(() => {
            checkNetwork();
        }, 5000);
    </script>
</body>
</html>